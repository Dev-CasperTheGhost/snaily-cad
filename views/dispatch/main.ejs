<%- include("../partials/header.ejs") %>

<div class="container-fluid mt-2">

    <h2 class="card-title text-light">Dispatch - AOP: <%= cad.AOP %></h2>
    <div class="card bg-secondary  mx-auto mb-4">
        <div class="card-header text-light bolder">
            Utility Panel
            <span class="float-right" id="date"></span>
        </div>
        <div class="card-body row ">
            <button class="btn btn-primary list-group-item text-light btn-dark bg-dark mt-2" data-target="#nameSearch"
            data-toggle="modal">Name Search</button>

            <button class="btn btn-primary list-group-item text-light btn-dark bg-dark ml-2 mt-2" data-target="#plateSearch"
            data-toggle="modal">Plate Search</button>

            <button class="btn no-out btn-primary list-group-item text-light btn-dark bg-dark ml-2 mt-2" data-target="#weaponSearch"
                data-toggle="modal">Weapon Search</button>

                <button class="btn text-light btn-dark bg-dark no-out btn-primary list-group-item ml-2 mt-2" data-target="#addressSearch"
                data-toggle="modal">Address Search</button>

                <button class="btn text-light btn-dark bg-dark no-out btn-primary list-group-item ml-2 mt-2" data-target="#bolo"
                data-toggle="modal">Create Bolo</button>
        </div>
    </div>        <ul class="list-group list-group-flush ">

            <!-- Name Search Modal -->
            

            <div class="modal fade" id="nameSearch" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl" role="document">
                  <div class="modal-content bg-dark border-dark">
                    <div class="modal-header">
                      <h5 class="modal-title text-light" id="exampleModalLabel">Name Search</h5>
                      <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <!-- action="/cad/<%= cadId %>/officers/search/name" -->
                      <form id="modal" onsubmit="event.preventDefault(); return nameSearch()">
                          <div class="form-group">
                              <label for="bolo" class="text-light">Name</label>
                              <input type="text" required class="form-control bg-secondary text-light border-secondary" name="name" id="nameSearchIn" placeholder="Search By Name">
                          </div>
                          <div class="container">
                            <div class="row">
                              <div class="col-sm-6">
                                <h6 class="card-title bolder text-light">Person Info</h6>
                                    <div id="personInfo" class="text-light"></div>
                              </div>
                              <div class="col-sm-6">
                                <h6 class="card-title bolder text-light">Licenses</h6>
                                <div id="licenses" class="text-light"></div>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col">
                                <h6 class="card-title bolder text-light mt-3">Charges/Offences</h6>
                                    <div id="charges" class="overflow-auto" style="max-height: 15rem;" class="text-light">
          
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                              <div class="col">
                                <h6 class="card-title bolder text-light mt-3">Warrants</h6>
                                    <div id="warrants" class="overflow-auto" style="max-height: 15rem;" class="text-light">
          
                                    </div>
                                </div>
                            </div>
                          </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
                </form>
                  </div>
                </div>
              </div>
            <!-- Plate Search Modal -->
           
           <!-- Plate Search -->
    <div class="modal fade" id="plateSearch" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content bg-dark border-dark">
            <div class="modal-header">
              <h5 class="modal-title text-light" id="exampleModalLabel">Plate Search</h5>
              <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="modal" onsubmit="event.preventDefault(); return plateSearch()">
                  <div class="form-group">
                      <label for="plate" class="text-light">Plate</label>
                      <input type="text" class="form-control text-light bg-secondary border-secondary" min="1" max="8" maxlength="8" name="plate" id="plateSearchIn" placeholder="Search By Name">
                  </div>
                  <div class="container">
                    <div class="row">
                      <div id="plates" class="text-light"></div>
                    </div>
                  </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
        </form>
          </div>
        </div>
      </div>


            <!-- Weapon Search Modal -->
            

            <div class="modal fade" id="weaponSearch" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Weapon Search</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="/cad/<%= cadId %>/dispatch/search/weapon" id="modal" method="post">
                                <div class="form-group">
                                    <label for="weapon-search">Search By Weapon</label>
                                    <select name="weapon_search" id="weapon-search" class="form-control"
                                        placeholder="Search By Weapon">
                                        <% weapons.forEach(weapon => {%>
                                        <option value="<%= weapon.name %>"><%= weapon.name %></option>
                                        <% }) %>
                                    </select>

                                </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="bolo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content bg-dark border-dark text-light">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Create Bolo</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="/cad/<%= cadId %>/dispatch/bolo" id="modal" method="post">
                                <div class="form-group">
                                    <label for="bolo">Bolo Description</label>
                                    <textarea name="bolo_desc" id="bolo" cols="30" rows="5" maxlength="1800" minlength="10" class="form-control bg-secondary border-secondary text-light" placeholder="Bolo Description, Min Length of 10 characters"></textarea>
                                </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Bolo</button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>


            <!-- Adress Search Modal -->
            <div class="modal fade" id="addressSearch" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content bg-dark border-dark text-light">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Address Search</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="/cad/<%= cadId %>/dispatch/search/address" id="modal" method="post">
                                <div class="form-group">
                                    <label for="address-search">Search By Address</label>
                                    <select name="address_search" id="weapon-search" class="form-control text-light bg-secondary border-secondary"
                                        placeholder="Search By address">
                                        <% address.forEach(add => {%>
                                        <option value="<%= add.address %>"><%= add.address %></option>
                                        <% }) %>
                                    </select>

                                </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>

                        </form>
                    </div>
                </div>

                
        </ul>
    </div>




    <div class="container-fluid mx-auto">
        <div class="row">
          <div class="col-8 mb-4">
            <ul class="list-group">
                <div class="active list-group-item text-light ">Active Units</div>
                
                <!-- <span class="border-top-0"></span> -->
                <% if (officers.length > 0) { %>
                    <% officers.forEach(officer => {%>
                        <% if(officer.status == "10-42 | 10-7" || officer.status == "") {%>
                        <!-- <p>not on duty</p> -->
                        <%} else { %>
                        <li class="list-group-item form-inline text-light bg-dark">
                            <form action="/cad/<%= cadId %>/dispatch/status" method="post">
                                <input type="text" class="custom text-light bg-dark" name="id" value="<%= officer.id %>"> | <%= officer.officer_dept %> |
                                <%= officer.officer_name %> |
                                <%= officer.status2 %>
                                <select id="10_41" class="custom-select my-1 mr-sm-2 text-light bg-dark" name="status" id="inlineFormCustomSelectPref">
                                    <option selected value="<%= officer.status %>"><%= officer.status %></option>
                                    <option value="" disabled>New Status..</option>
                                    <option value="10-41 | 10-8">10-41 | 10-8</option>
                                    <option value="10-42 | 10-7">10-42 | 10-7</option>
                                </select>
                                <select id="status2" class="custom-select my-1 mr-sm-2 text-light bg-dark" name="status2" id="inlineFormCustomSelectPref">
                                    <option selected value="<%= officer.status2 %>"><%= officer.status2 %></option>
                                    <option value="" disabled>New Status..</option>
                                    <option value="10-6">10-6</option>
                                    <option value="10-5">10-5</option>
                                    <option value="10-12">10-12</option>
                                    <option value="10-97">10-97</option>
                                    <option value="10-11">10-11</option>
                                    <option value="Signal 11">Signal 11</option>
                                    <option value="Code 5">Code 5</option>
                                </select>
                                <button type="submit" class="btn btn-success">Change Status</button>
                            </form>
                        </li>
                        <%} %>
                    <% })  %>
                    <%} else { %>
                        <li class="list-group-item bg-dark text-light">
                            No Active Police Deputies
                        </li>
                        <%} %>
                
    
                <div class="active list-group-item text-light">Active EMS</div>
                <% if (ems.length > 0) { %>
                    <% ems.forEach(ems => {%>
                        <% if(ems.status == "10-42 | 10-7" || ems.status == "") {%>
                        <!-- <p>not on duty</p> -->
                        <%} else { %>
                        <li class="list-group-item form-inline text-light bg-dark">
                            <form action="/cad/<%= cadId %>/dispatch/status-ems" method="post">
                                <input type="text" class="custom text-light bg-dark" name="id" value="<%= ems.id %>"> |
                                <%= ems.name %> |
                               Currently:  <%= ems.status2 %> | 
                                <select id="10_41" class="custom-select my-1 mr-sm-2 text-light bg-dark" name="status" id="inlineFormCustomSelectPref">
                                    <option selected value="<%= ems.status %>"><%= ems.status %></option>
                                    <option value="" disabled>New Status..</option>
                                    <option value="10-41 | 10-8">10-41 | 10-8</option>
                                    <option value="10-42 | 10-7">10-42 | 10-7</option>
                                </select>
                                <select id="status2" class="custom-select my-1 mr-sm-2 text-light bg-dark" name="status2" id="inlineFormCustomSelectPref">
                                    <option selected value="<%= ems.status2 %>"><%= ems.status2 %></option>
                                    <option value="" disabled>New Status..</option>
                                    <option value="10-6">10-6</option>
                                    <option value="10-5">10-5</option>
                                    <option value="10-12">10-12</option>
                                    <option value="10-97">10-97</option>
                                    <option value="10-11">10-11</option>
                                    <option value="Signal 11">Signal 11</option>
                                    <option value="Code 5">Code 5</option>
                                </select>
                                <button type="submit" class="btn btn-success">Change Status</button>
                            </form>
                        </li>
                        <%} %>
                    <% }) %>
                <%} else { %>
                    <li class="list-group-item bg-dark text-light">
                        No Active EMS/FD Deputies
                    </li>
                <%} %>
                
                </ul>
          </div>
          <div class="col ">
            <ul class="list-group mb-4" >
                <div class="active list-group-item text-light ">Edit AOP</div>
                <form class="list-group-item bg-dark border-dark text-light " action="/cad/<%= cadId %>/dispatch/aop" method="post">
                    <div class="form-group">
                        <label for="input">New AOP</label>
                        <input type="text" id="input" name="aop" placeholder="New Area Of Roleplay" minlength="1" maxlength="255" max="255" min="1" class="form-control bg-dark border-secondary text-light">
                    </div>
                    <button type="submit" class="container btn btn-success">Update AOP</button>
                </form>
            </ul>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <ul class="list-group mt-3" >
                <div class="active list-group-item text-light ">Active Bolos</div>
                <% if (bolos.length > 0) {%>
                    <% bolos.forEach(bolo => { %>
                        <li class="list-group-item bg-dark text-light">
                            <form action="/cad/<%= cadId %>/dispatch/remove-bolo" method="POST">
                                <input type="text" name="boloID" value="<%= bolo.id %>" class="removeBolo">| <%= bolo.description %> 
                                  <div class="float-right">
                                    <button type="submit" class="btn btn-danger">Remove Bolo</a>
                                  </div>
                              </form>
                        </li>
                    <%}) %>
                <%} else {%>
                    <li class="list-group-item bg-dark text-light">
                        No Active Bolos
                    </li>
                <%}%>                 
            </ul>
          </div>
          <!-- <div class="col-6">
            2 of 3
          </div> -->
        </div>
      </div>

    <br><br>
    <div class="container">
        
                
                
    </div>

</div>

<div class="mb-4"></div>



<script>
    const xhttp = new XMLHttpRequest();



    setInterval(function() {
        let date = document.getElementById("date")
        let d = new Date()
        let currenttime = d.toLocaleTimeString()
        let currentDate = d.toLocaleDateString()
        date.textContent = currenttime + " - " + currentDate;
    }, 100)

    function nameSearch() {
    const nameSearchInputValue = document.getElementById("nameSearchIn").value
    xhttp.open("GET", `/cad/<%= cadId %>/officers/api/${nameSearchInputValue}`, true);
    
    xhttp.onload = function() {
      if (this.status === 200) {
        let result = JSON.parse(this.responseText);

        
      
        let person = '';
        let licenses = '';
        let warrant;

        person += '<ul>' + 
          '<li><span class="bolder mt-1"> Full Name:</span> ' + result[1][0].full_name +'</li>' +
          '<li><span class="bolder mt-1"> Gender:</span> ' + result[1][0].gender +'</li>'+
          '<li><span class="bolder mt-1"> Day of Birth:</span> ' + result[1][0].birth +'</li>'+
          '<li><span class="bolder mt-1"> Ethnicity:</span> ' + result[1][0].ethnicity +'</li>'+
          '<li><span class="bolder mt-1"> Hair Color:</span> ' + result[1][0].hair +'</li>'+
          '<li><span class="bolder mt-1"> Eye Color:</span> ' + result[1][0].eyes +'</li>'+
          '<li><span class="bolder mt-1"> Address:</span> ' + result[1][0].address +'</li>'+
          '<li><span class="bolder mt-1"> Height / Weight: </span> ' + result[1][0].height + " / " + result[1][0].weight + '</li>'+
          '</ul>';
        
        licenses += '<ul>' +
          '<li><span class="bolder mt-1"> Drivers Licenses:</span> ' + result[1][0].dmv +'</li>' +
          '<li><span class="bolder mt-1"> Firearms Licenses:</span> ' + result[1][0].fire_licence +'</li>' +
          '<li><span class="bolder mt-1"> Pilot License:</span> ' + result[1][0].pilot_licence +'</li>' +
          '<li><span class="bolder mt-1"> CCW:</span> ' + result[1][0].ccw +'</li>' +
          '</ul>'



          if (result[2].length > 0) {
            let charges = result[2].map(charge => {
              return  '<li class="list-group-item"> ' + charge.charge + ' <br />  <span class="bolder">Given On </span> '+ charge.date +' <br /> <span class="bolder">Nearest Postal</span> '+ charge.postal +' </li>'
            })
            document.getElementById("charges").innerHTML = charges.join('\n');
          }  else {
            document.getElementById("charges").innerHTML = '<li class="list-group-item">Person Has No Charges/Offences</li>'
          }
        
        if (result[0].length > 0) {
          warrants = result[0].map(warrant => {
            return   '<li class="list-group-item">  <span class="card-title bolder"> Warrant: </span> '+warrant.reason+' <br> <span class="card-title bolder">Date From, To: </span> '+ warrant.d_from + ' - ' + warrant.d_to +' </li>'
          });
          document.getElementById("warrants").innerHTML = warrants.join('\n');
        } else {
          document.getElementById("warrants").innerHTML = '<li class="list-group-item">Person Has No Warrants</li>';
        }
        

        document.getElementById("personInfo").innerHTML = person;
        document.getElementById("licenses").innerHTML = licenses;
      } 
    }


    xhttp.send();
  }

    function plateSearch() {
    const plateSearchInputValue = document.getElementById("plateSearchIn").value
    xhttp.open("GET", `/cad/<%= cadId %>/officers/api/plate/${plateSearchInputValue}`, true);
    
    xhttp.onload = function() {
      if (this.status === 200) {
        let result = JSON.parse(this.responseText);

        console.log(result);

        let plates = '';
      
        if (result.length > 0) {
          plates += '<ul>' + 
          '<li><span class="bolder mt-1"> Plate:</span> ' + result[0].plate +'</li>' +
          '<li><span class="bolder mt-1"> Vehicle:</span> ' + result[0].vehicle +'</li>'+
          '<li><span class="bolder mt-1"> VIN Number:</span> ' + result[0].vin_number +'</li>'+
          '<li><span class="bolder mt-1"> Color:</span> ' + result[0].color +'</li>'+
          '<li><span class="bolder mt-1"> Insurance Status:</span> ' + result[0].in_status +'</li>'+
          '<li><span class="bolder mt-1"> Owner:</span> ' + result[0].owner +'</li>'+
          '</ul>';
        

        document.getElementById("plates").innerHTML = plates;
        } else {
        document.getElementById("plates").innerHTML = "Plate was not found";
        }

        
      }
    }


    xhttp.send();
  }
</script>